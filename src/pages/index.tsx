import { type NextPage } from "next";
import Head from "next/head";
import Link from "next/link";
import { signIn, signOut, useSession } from "next-auth/react";

import { api } from "../utils/api";
import { ChampionCard } from "../components/ChampionCard";
import { useEffect, useState } from "react";
import { Champion } from "../components/Champion.interface";
import { number, string } from "prop-types";
import TraitTable from "../components/TraitTable";
import { ResetButton } from "../components/ResetButton";

const someChampions: Champion[] = [
  {
    src: "/imgs/icons/champions/tft8_blitzcrank_square.tft_set8.png",
    name: "Blitzrank",
    origin: ["A.D.M.I.N."],
    class: ["Brawler"],
  },
  {
    src: "/imgs/icons/champions/tft8_janna_square.tft_set8.png",
    name: "Janna",
    origin: ["Civilian"],
    class: ["Forecaster", "Spellslinger"],
  },
  {
    src: "/imgs/icons/champions/tft8_belveth_square.tft_set8.png",
    name: "Bel'Veth",
    origin: ["Threat"],
    class: [""],
  },
  {
    src: "/imgs/icons/champions/tft8_fiddlesticks_square.tft_set8.png",
    name: "Fiddlesticks",
    origin: ["Threat", "Corrupted"],
    class: [""],
  },
  {
    src: "/imgs/icons/champions/tft8_jinx_square.tft_set8.png",
    name: "Jinx",
    origin: ["Anima Squad"],
    class: ["Prankster"],
  },
  {
    src: "/imgs/icons/champions/tft8_leblanc_square.tft_set8.png",
    name: "LeBlanc",
    origin: ["A.D.M.I.N."],
    class: ["Spellslinger", "Hacker"],
  },
  {
    src: "/imgs/icons/champions/tft8_chogath_square.tft_set8.png",
    name: "Cho'Gath",
    origin: ["Threat"],
    class: [""],
  },
  {
    src: "/imgs/icons/champions/tft8_missfortune_square.tft_set8.png",
    name: "Miss Fortune",
    origin: ["Anima Squad"],
    class: ["Ace"],
  },
  {
    src: "imgs/icons/champions/tft8_soraka_square.tft_set8.png",
    name: "Soraka",
    origin: ["A.D.M.I.N."],
    class: ["Heart"],
  },
  {
    src: "imgs/icons/champions/tft8_vi_square.tft_set8.png",
    name: "Vi",
    origin: ["The Underground"],
    class: ["Aegis", "Brawler"],
  },
  {
    src: "imgs/icons/champions/tft8_urgot_square.tft_set8.png",
    name: "Urgot",
    origin: ["Threat"],
    class: [""],
  },
  {
    src: "imgs/icons/champions/tft8_kaisa_square.tft_set8.png",
    name: "Kai'sa",
    origin: ["Star Guardian"],
    class: ["Recon"],
  },
  {
    src: "imgs/icons/champions/tft8_sejuani_square.tft_set8.png",
    name: "Sejuani",
    origin: ["Laser Corps"],
    class: ["Brawler"],
  },
  {
    src: "imgs/icons/champions/tft8_mordekaiser_square.tft_set8.png",
    name: "Mordekaiser",
    origin: ["Laser Corps"],
    class: ["Ace"],
  },
];

const Home: NextPage = () => {
  const [selectedChamps, setSelectedChamps] = useState<Champion[]>([]);
  const [traitCounts, setTraitCounts] = useState<{ [trait: string]: number }>(
    {}
  );

  const selectChamp = (champion: Champion) => {
    setSelectedChamps((oldArray) => [...oldArray, champion]);
  };

  const deselectChamp = (index: number) => {
    setSelectedChamps(selectedChamps.filter((item, idx) => idx !== index));
  };

  const resetSelectedChamps = () => {
    setSelectedChamps([]);
    setTraitCounts({});
  };

  const calculateTraits = (selectedChamps: Array<Champion>) => {
    let newTraitCounts: { [trait: string]: number } = {};

    const uniqueChamps = [...new Set(selectedChamps)];

    for (const champ of uniqueChamps) {
      for (var innerTrait of [...champ.origin, ...champ.class]) {
        if (innerTrait) {
          newTraitCounts[innerTrait] = newTraitCounts[innerTrait]
            ? newTraitCounts[innerTrait]! + 1
            : 1;
        }
      }
    }
    return newTraitCounts;
  };

  useEffect(() => {
    setTraitCounts(calculateTraits(selectedChamps));
  }, [selectedChamps]);

  return (
    <>
      <Head>
        <title>TFTree</title>
        <meta
          name="TFTree: Team builder and explorer"
          content="Generated by create-t3-app"
        />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex min-h-screen flex-col items-center justify-center gap-8 bg-gray-800 text-neutral-100">
        <h1 className="py-5 text-4xl">Team builder</h1>

        {/* Upper half */}
        <div className="flex">
          {/* Left half */}
          <div className="">
            {/* Buttons */}
            <div className="flex items-center justify-center gap-20 py-5">
              <div>
                <h2 className="text-2xl text-white">Selected champs</h2>
              </div>
              <div>
                <ResetButton onClick={resetSelectedChamps} />
              </div>
            </div>

            <div className="">
              <div className="grid grid-cols-5 gap-1">
                {selectedChamps.map((champion, index) => (
                  <div
                    key={index}
                    className="w-32 cursor-pointer rounded-lg border-2 border-gray-100 bg-white shadow-md dark:border-gray-700 dark:bg-gray-800"
                    onClick={() => deselectChamp(index)}
                  >
                    <img
                      className="rounded-t-lg"
                      src={champion.src}
                      alt={champion.name}
                      title={champion.name}
                    />
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Right half */}
          <div className="py-5 px-5">
            <TraitTable traitCounts={traitCounts} />
          </div>
        </div>

        {/* Bottom half */}
        {/* Champ roster */}
        <h2 className="text-2xl text-white">Champions</h2>
        <div className="grid grid-cols-10 gap-1">
          {someChampions.map((champion, index) => (
            <div
              key={index}
              className="w-24 cursor-pointer rounded-lg border-2 border-gray-100 bg-white shadow-md dark:border-gray-700 dark:bg-gray-800"
              onClick={() => selectChamp(champion)}
            >
              <img
                className="rounded-t-lg"
                src={champion.src}
                alt={champion.name}
                title={champion.name}
              />
            </div>
          ))}
        </div>
      </main>
    </>
  );
};

export default Home;
